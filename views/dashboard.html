<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hora Extra">
  <meta name="description" content="Dashboard com estatísticas dos atendimentos">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <title>Dashboard - Hora Extra</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .chart-container {
      margin: 30px 0;
      padding: 25px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .export-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn-export {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-export:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .export-buttons {
        flex-direction: column;
      }
      
      .btn-export {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="menu">
      <a href="/home">Home</a>
      <a href="/cadastrar-cliente">Cadastrar Cliente</a>
      <a href="/perfil">Perfil</a>
      <a href="#" id="logout">Sair</a>
    </nav>

    <h1>Dashboard</h1>
    <p style="text-align: center; color: #64748b; margin-bottom: 30px;">
      Estatísticas dos seus atendimentos
    </p>

    <!-- Estatísticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Atendimentos Hoje</div>
        <div class="stat-value" id="atendimentosHoje">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total de Horas</div>
        <div class="stat-value" id="totalHoras">00:00</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Média por Atendimento</div>
        <div class="stat-value" id="mediaTempo">00:00</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Cliente Mais Atendido</div>
        <div class="stat-value" id="clienteFrequente">-</div>
      </div>
    </div>

    <!-- Filtros -->
    <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 15px;">
      <h3>Filtros</h3>
      <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label for="dataInicio">Data Inicial</label>
          <input type="date" id="dataInicio">
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label for="dataFim">Data Final</label>
          <input type="date" id="dataFim">
        </div>
        <button id="filtrarBtn" class="btn">Filtrar</button>
        <button id="limparBtn" class="btn btn-secondary">Limpar</button>
      </div>
    </div>

    <!-- Gráfico -->
    <div class="chart-container">
      <h3>Atendimentos por Dia</h3>
      <canvas id="graficoAtendimentos"></canvas>
    </div>

    <!-- Botões de Exportação -->
    <div class="export-buttons">
      <button class="btn-export" onclick="exportarExcel()">
        Exportar para Excel
      </button>
      <button class="btn-export" onclick="exportarJSON()">
        Exportar JSON
      </button>
      <button class="btn-export" onclick="imprimirRelatorio()">
        Imprimir Relatório
      </button>
    </div>

    <!-- Lista de Atendimentos -->
    <div style="margin: 30px 0;">
      <h3>Últimos Atendimentos</h3>
      <div id="listaAtendimentos">
        <p style="text-align: center; color: #64748b;">Carregando...</p>
      </div>
    </div>

    <div id="mensagem" class="mensagem"></div>
  </div>

  <script>
    const logoutBtn = document.getElementById("logout");
    const atendimentosHoje = document.getElementById("atendimentosHoje");
    const totalHoras = document.getElementById("totalHoras");
    const mediaTempo = document.getElementById("mediaTempo");
    const clienteFrequente = document.getElementById("clienteFrequente");
    const listaAtendimentos = document.getElementById("listaAtendimentos");
    const mensagemEl = document.getElementById("mensagem");
    
    let dadosAtendimentos = [];

    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "/login";
    });

    // Configurar datas padrão (hoje)
    const hoje = new Date();
    document.getElementById("dataFim").value = hoje.toISOString().split('T')[0];
    const umaSemanaAtras = new Date(hoje);
    umaSemanaAtras.setDate(hoje.getDate() - 7);
    document.getElementById("dataInicio").value = umaSemanaAtras.toISOString().split('T')[0];

    // Carregar estatísticas
    const carregarEstatisticas = async () => {
      try {
        const token = localStorage.getItem("token");
        const dataInicio = document.getElementById("dataInicio").value;
        const dataFim = document.getElementById("dataFim").value;

        const res = await fetch(`/atendimentos/estatisticas?inicio=${dataInicio}&fim=${dataFim}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();

        if (res.ok) {
          dadosAtendimentos = data.atendimentos;
          
          // Atualizar estatísticas
          atendimentosHoje.textContent = data.totalAtendimentos || 0;
          totalHoras.textContent = formatarHoras(data.totalHoras || 0);
          mediaTempo.textContent = formatarHoras(data.mediaHoras || 0);
          clienteFrequente.textContent = data.clienteFrequente || "-";
          
          // Atualizar gráfico
          atualizarGrafico(data.grafico || []);
          
          // Atualizar lista
          atualizarLista(data.atendimentos || []);
        } else {
          mostrarMensagem(data.error || "Erro ao carregar estatísticas", "red");
        }
      } catch (err) {
        console.error(err);
        mostrarMensagem("Erro de conexão com o servidor", "red");
      }
    };

    // Atualizar gráfico
    const ctx = document.getElementById('graficoAtendimentos').getContext('2d');
    let chart = null;

    const atualizarGrafico = (dados) => {
      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dados.map(d => d.data),
          datasets: [{
            label: 'Atendimentos',
            data: dados.map(d => d.count),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    };

    // Atualizar lista de atendimentos
    const atualizarLista = (atendimentos) => {
      if (atendimentos.length === 0) {
        listaAtendimentos.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhum atendimento encontrado</p>';
        return;
      }

      let html = '';
      atendimentos.forEach(atendimento => {
        const inicio = new Date(atendimento.inicio).toLocaleString('pt-BR');
        const fim = atendimento.fim ? new Date(atendimento.fim).toLocaleString('pt-BR') : 'Em andamento';
        const duracao = atendimento.duracao ? formatarHoras(atendimento.duracao) : '-';
        
        html += `
          <div class="atendimento-item" style="margin-bottom: 15px;">
            <div class="atendimento-info">
              <h4>${atendimento.cliente.nome}</h4>
              <p>Início: ${inicio}</p>
              <p>Fim: ${fim}</p>
              <p>Duração: ${duracao}</p>
              ${atendimento.observacao ? `<p>Observação: ${atendimento.observacao}</p>` : ''}
            </div>
          </div>
        `;
      });

      listaAtendimentos.innerHTML = html;
    };

    // Formatar horas
    const formatarHoras = (milissegundos) => {
      if (!milissegundos || milissegundos === 0) return "00:00:00";
      
      // Se o valor for muito grande (provavelmente já está em milissegundos)
      let segundos;
      if (milissegundos > 1000) {
        segundos = Math.floor(milissegundos / 1000);
      } else {
        segundos = milissegundos;
      }
      
      const horas = Math.floor(segundos / 3600);
      const minutos = Math.floor((segundos % 3600) / 60);
      const segundosRestantes = segundos % 60;
      return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundosRestantes).padStart(2, '0')}`;
    };

    // Exportar para Excel
    const exportarExcel = () => {
      try {
        const wb = XLSX.utils.book_new();
        
        // Preparar dados para Excel
        const dados = dadosAtendimentos.map(a => ({
          'Cliente': a.cliente.nome,
          'Início': new Date(a.inicio).toLocaleString('pt-BR'),
          'Fim': a.fim ? new Date(a.fim).toLocaleString('pt-BR') : 'Em andamento',
          'Duração': a.duracao ? formatarHoras(a.duracao) : '-',
          'Observação': a.observacao || ''
        }));

        const ws = XLSX.utils.json_to_sheet(dados);
        XLSX.utils.book_append_sheet(wb, ws, "Atendimentos");
        XLSX.writeFile(wb, "atendimentos.xlsx");
        
        mostrarMensagem("Excel exportado com sucesso!", "green");
      } catch (err) {
        console.error(err);
        mostrarMensagem("Erro ao exportar Excel", "red");
      }
    };

    // Exportar JSON
    const exportarJSON = () => {
      try {
        const dataStr = JSON.stringify(dadosAtendimentos, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'atendimentos.json';
        link.click();
        URL.revokeObjectURL(url);
        
        mostrarMensagem("JSON exportado com sucesso!", "green");
      } catch (err) {
        console.error(err);
        mostrarMensagem("Erro ao exportar JSON", "red");
      }
    };

    // Imprimir relatório
    const imprimirRelatorio = () => {
      window.print();
    };

    // Mostrar mensagem
    const mostrarMensagem = (texto, cor) => {
      mensagemEl.textContent = texto;
      mensagemEl.style.color = cor;
      setTimeout(() => {
        mensagemEl.textContent = "";
      }, 3000);
    };

    // Eventos dos filtros
    document.getElementById("filtrarBtn").addEventListener("click", carregarEstatisticas);
    document.getElementById("limparBtn").addEventListener("click", () => {
      const hoje = new Date();
      document.getElementById("dataFim").value = hoje.toISOString().split('T')[0];
      const umaSemanaAtras = new Date(hoje);
      umaSemanaAtras.setDate(hoje.getDate() - 7);
      document.getElementById("dataInicio").value = umaSemanaAtras.toISOString().split('T')[0];
      carregarEstatisticas();
    });

    // Inicializar
    carregarEstatisticas();

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registrado'))
        .catch(err => console.log('Erro ao registrar Service Worker:', err));
    }
  </script>
</body>
</html>
