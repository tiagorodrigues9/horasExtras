<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hora Extra">
  <meta name="description" content="Dashboard principal do sistema Hora Extra">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <title>Home - Hora Extra</title>
  <link rel="stylesheet" href="/css/style.css?v=2.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="container">
    <!-- Menu de navegação -->
    <nav class="menu">
      <a href="/cadastrar-cliente">Cliente</a>
      <a href="/perfil">Perfil</a>
      <a href="#" id="logout">Sair</a>
    </nav>

    <h1>Bem-vindo!</h1>
    <p style="text-align: center; color: #64748b; margin-bottom: 30px;">Gerencie seus atendimentos e clientes</p>

    <!-- Botão de Dashboard -->
    <div style="text-align: center; margin: 30px 0; padding: 20px;">
      <a href="/dashboard" style="display: inline-block !important; padding: 20px 40px !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; text-decoration: none !important; border-radius: 15px !important; font-size: 1.2rem !important; font-weight: 600 !important; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3) !important; transition: all 0.3s ease !important; min-width: 300px;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 40px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(102, 126, 234, 0.3)'">
        Dashboard - Ver Estatísticas
      </a>
    </div>

    <!-- Seção de Novo Atendimento -->
    <div class="novo-atendimento">
      <h2>Iniciar Novo Atendimento</h2>
      <div class="form-group">
        <label for="clienteSelect">Selecione o cliente:</label>
        <select id="clienteSelect">
          <option value="">Carregando clientes...</option>
        </select>
      </div>
      <button id="startBtn" class="btn submit-btn">Iniciar Atendimento</button>
    </div>

    <!-- Seção de Atendimentos em Aberto -->
    <div class="atendimentos-abertos">
      <h2>Atendimentos em Aberto</h2>
      <div id="listaAtendimentos" class="lista-atendimentos">
        <!-- Atendimentos serão carregados aqui -->
      </div>
    </div>

    <!-- Modal para Observações -->
    <div id="modalObservacoes" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>Finalizar Atendimento</h3>
        <div class="form-group">
          <label for="observacaoFinalizar">Observações sobre o atendimento:</label>
          <textarea id="observacaoFinalizar" placeholder="Digite suas observações sobre o atendimento..." rows="4"></textarea>
        </div>
        <div class="modal-buttons">
          <button id="cancelarFinalizar" class="btn btn-secondary">Cancelar</button>
          <button id="confirmarFinalizar" class="btn">Finalizar</button>
        </div>
      </div>
    </div>

    <div id="mensagem" class="mensagem"></div>
  </div>

  <script>
    // Variáveis globais
    let atendimentoAtual = null;
    let timerInterval = null;
    let startTime = null;

    // Elementos DOM
    const clienteSelect = document.getElementById("clienteSelect");
    const iniciarBtn = document.getElementById("startBtn");
    const listaAtendimentos = document.getElementById("listaAtendimentos");
    const modalObservacoes = document.getElementById("modalObservacoes");
    const observacaoFinalizar = document.getElementById("observacaoFinalizar");
    const cancelarFinalizar = document.getElementById("cancelarFinalizar");
    const confirmarFinalizar = document.getElementById("confirmarFinalizar");
    const mensagemEl = document.getElementById("mensagem");
    const logoutBtn = document.getElementById("logout");

    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "/login";
    });

    // Carregar clientes
    const carregarClientes = async () => {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch("/clientes", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const clientes = await res.json();
        clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
        clientes.forEach(c => {
          const option = document.createElement("option");
          option.value = c._id;
          option.textContent = c.nome;
          clienteSelect.appendChild(option);
        });
      } catch (err) {
        console.error(err);
        clienteSelect.innerHTML = '<option value="">Erro ao carregar clientes</option>';
      }
    };

    // Carregar atendimentos em aberto
    const carregarAtendimentos = async () => {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch("/atendimentos", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const atendimentos = await res.json();
        
        listaAtendimentos.innerHTML = "";
        
        if (atendimentos.length === 0) {
          listaAtendimentos.innerHTML = '<p class="sem-atendimentos">Nenhum atendimento em aberto</p>';
          return;
        }

        atendimentos.forEach(atendimento => {
          const div = document.createElement("div");
          div.className = "atendimento-item";
          div.innerHTML = `
            <div class="atendimento-info">
              <h4>${atendimento.cliente.nome}</h4>
              <p>Iniciado em: ${new Date(atendimento.inicio).toLocaleString()}</p>
              <p class="tempo-decorrido" data-inicio="${atendimento.inicio}">00:00:00</p>
            </div>
            <button class="btn btn-danger finalizar-btn" data-id="${atendimento._id}">
              Finalizar Atendimento
            </button>
          `;
          listaAtendimentos.appendChild(div);
        });

        // Iniciar timers para cada atendimento
        iniciarTimers();
      } catch (err) {
        console.error(err);
        listaAtendimentos.innerHTML = '<p class="erro">Erro ao carregar atendimentos</p>';
      }
    };

    // Iniciar timers para mostrar tempo decorrido
    const iniciarTimers = () => {
      const timers = document.querySelectorAll('.tempo-decorrido');
      timers.forEach(timer => {
        const inicio = new Date(timer.dataset.inicio).getTime();
        
        const updateTimer = () => {
          const agora = Date.now();
          const decorrido = agora - inicio;
          timer.textContent = formatarTempo(decorrido);
        };
        
        updateTimer();
        setInterval(updateTimer, 1000);
      });
    };

    // Formatar tempo
    const formatarTempo = (ms) => {
      const totalSeconds = Math.floor(ms / 1000);
      const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const secs = String(totalSeconds % 60).padStart(2, "0");
      return `${hrs}:${mins}:${secs}`;
    };

    // Iniciar atendimento
    iniciarBtn.addEventListener("click", async () => {
      if (!clienteSelect.value) {
        mostrarMensagem("Selecione um cliente antes de iniciar o atendimento.", "red");
        return;
      }

      try {
        const token = localStorage.getItem("token");
        const res = await fetch("/atendimentos/iniciar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ clienteId: clienteSelect.value })
        });

        const data = await res.json();

        if (res.ok) {
          mostrarMensagem("Atendimento iniciado com sucesso!", "green");
          clienteSelect.value = "";
          carregarAtendimentos();
        } else {
          mostrarMensagem(data.error || "Erro ao iniciar atendimento", "red");
        }
      } catch (err) {
        console.error(err);
        mostrarMensagem("Erro de conexão com o servidor", "red");
      }
    });

    // Event delegation para botões de finalizar
    listaAtendimentos.addEventListener("click", (e) => {
      if (e.target.classList.contains("finalizar-btn")) {
        const atendimentoId = e.target.dataset.id;
        abrirModalFinalizar(atendimentoId);
      }
    });

    // Abrir modal de finalização
    const abrirModalFinalizar = (atendimentoId) => {
      atendimentoAtual = atendimentoId;
      observacaoFinalizar.value = "";
      modalObservacoes.style.display = "block";
    };

    // Fechar modal
    const fecharModal = () => {
      modalObservacoes.style.display = "none";
      atendimentoAtual = null;
    };

    cancelarFinalizar.addEventListener("click", fecharModal);

    // Confirmar finalização
    confirmarFinalizar.addEventListener("click", async () => {
      if (!atendimentoAtual) return;

      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/atendimentos/finalizar/${atendimentoAtual}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            observacao: observacaoFinalizar.value.trim()
          })
        });

        const data = await res.json();

        if (res.ok) {
          mostrarMensagem("Atendimento finalizado com sucesso!", "green");
          fecharModal();
          carregarAtendimentos();
        } else {
          mostrarMensagem(data.error || "Erro ao finalizar atendimento", "red");
        }
      } catch (err) {
        console.error(err);
        mostrarMensagem("Erro de conexão com o servidor", "red");
      }
    });

    // Fechar modal clicando fora
    modalObservacoes.addEventListener("click", (e) => {
      if (e.target === modalObservacoes) {
        fecharModal();
      }
    });

    // Mostrar mensagem
    const mostrarMensagem = (texto, cor) => {
      mensagemEl.textContent = texto;
      mensagemEl.style.color = cor;
      setTimeout(() => {
        mensagemEl.textContent = "";
      }, 3000);
    };

    // Registra o Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registrado com sucesso:', registration.scope);
          })
          .catch((error) => {
            console.log('Falha ao registrar Service Worker:', error);
          });
      });
    }

    // Inicializar página
    carregarClientes();
    carregarAtendimentos();
    
    // Recarregar atendimentos a cada 30 segundos
    setInterval(carregarAtendimentos, 30000);
  </script>
</body>
</html>
