name: Update Dependencies

on:
  schedule:
    # Executa diariamente Ã s 3h da manhÃ£ (horÃ¡rio de BrasÃ­lia)
    - cron: "0 3 * * *"
  workflow_dispatch: # Permite execuÃ§Ã£o manual
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'frontend/package.json'

jobs:
  update-backend:
    name: Update Backend Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar npm-check-updates
        run: npm install -g npm-check-updates

      - name: Verificar atualizaÃ§Ãµes do backend
        id: check-backend
        run: |
          cd ${{ github.workspace }}
          ncu --format json > backend-updates.json || echo "[]" > backend-updates.json
          
          # Verifica se hÃ¡ atualizaÃ§Ãµes
          UPDATES=$(cat backend-updates.json | jq 'length')
          echo "updates_count=$UPDATES" >> $GITHUB_OUTPUT
          
          if [ "$UPDATES" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Atualizar package.json do backend
        if: steps.check-backend.outputs.has_updates == 'true'
        run: |
          cd ${{ github.workspace }}
          ncu -u

      - name: Instalar dependÃªncias atualizadas
        if: steps.check-backend.outputs.has_updates == 'true'
        run: |
          cd ${{ github.workspace }}
          npm install

      - name: Criar Pull Request (Backend)
        if: steps.check-backend.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(backend): atualizar dependÃªncias automaticamente"
          title: "ğŸ”„ Atualizar dependÃªncias do backend"
          body: |
            ## ğŸ“¦ AtualizaÃ§Ã£o AutomÃ¡tica de DependÃªncias - Backend
            
            Este PR foi criado automaticamente para atualizar as dependÃªncias do backend.
            
            ### ğŸ“Š Resumo
            - **Total de atualizaÃ§Ãµes**: ${{ steps.check-backend.outputs.updates_count }}
            
            ### âš ï¸ AÃ§Ãµes necessÃ¡rias
            - [ ] Revisar as mudanÃ§as
            - [ ] Testar a aplicaÃ§Ã£o localmente
            - [ ] Verificar se nÃ£o hÃ¡ breaking changes
            - [ ] Aprovar e fazer merge quando estiver tudo ok
            
            ### ğŸ” Como revisar
            1. Verifique o arquivo `package.json` para ver as novas versÃµes
            2. Execute `npm install` localmente
            3. Teste a aplicaÃ§Ã£o
            4. Se tudo estiver ok, aprove o PR
            
            ---
            *Este PR foi criado automaticamente pelo workflow de atualizaÃ§Ã£o de dependÃªncias*
          branch: update-dependencies-backend
          delete-branch: true
          labels: |
            dependencies
            backend
            automated

  update-frontend:
    name: Update Frontend Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar npm-check-updates
        run: npm install -g npm-check-updates

      - name: Verificar atualizaÃ§Ãµes do frontend
        id: check-frontend
        run: |
          cd ${{ github.workspace }}/frontend
          ncu --format json > ../frontend-updates.json || echo "[]" > ../frontend-updates.json
          
          # Verifica se hÃ¡ atualizaÃ§Ãµes
          UPDATES=$(cat ../frontend-updates.json | jq 'length')
          echo "updates_count=$UPDATES" >> $GITHUB_OUTPUT
          
          if [ "$UPDATES" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Atualizar package.json do frontend
        if: steps.check-frontend.outputs.has_updates == 'true'
        run: |
          cd ${{ github.workspace }}/frontend
          ncu -u

      - name: Instalar dependÃªncias atualizadas
        if: steps.check-frontend.outputs.has_updates == 'true'
        run: |
          cd ${{ github.workspace }}/frontend
          npm install

      - name: Criar Pull Request (Frontend)
        if: steps.check-frontend.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(frontend): atualizar dependÃªncias automaticamente"
          title: "ğŸ”„ Atualizar dependÃªncias do frontend"
          body: |
            ## ğŸ“¦ AtualizaÃ§Ã£o AutomÃ¡tica de DependÃªncias - Frontend
            
            Este PR foi criado automaticamente para atualizar as dependÃªncias do frontend.
            
            ### ğŸ“Š Resumo
            - **Total de atualizaÃ§Ãµes**: ${{ steps.check-frontend.outputs.updates_count }}
            
            ### âš ï¸ AÃ§Ãµes necessÃ¡rias
            - [ ] Revisar as mudanÃ§as
            - [ ] Testar a aplicaÃ§Ã£o localmente
            - [ ] Verificar se nÃ£o hÃ¡ breaking changes
            - [ ] Aprovar e fazer merge quando estiver tudo ok
            
            ### ğŸ” Como revisar
            1. Verifique o arquivo `frontend/package.json` para ver as novas versÃµes
            2. Execute `cd frontend && npm install` localmente
            3. Teste a aplicaÃ§Ã£o
            4. Se tudo estiver ok, aprove o PR
            
            ---
            *Este PR foi criado automaticamente pelo workflow de atualizaÃ§Ã£o de dependÃªncias*
          branch: update-dependencies-frontend
          delete-branch: true
          labels: |
            dependencies
            frontend
            automated

